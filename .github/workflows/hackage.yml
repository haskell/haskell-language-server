name: Hackage

on:
  push:
    branches:
      - '*-hackage'

jobs:
  release:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ["hls-plugin-api", "ghcide", "hls-test-utils",
                  "hls-brittany-plugin", "hls-floskell-plugin", "hls-fourmolu-plugin",
                  "hls-ourmolu-plugin", "hls-stylish-haskell-plugin",
                  "hls-class-plugin", "hls-eval-plugin", "hls-explicit-imports-plugin",
                  "hls-haddock-comments-plugin", "hls-hlint-plugin",
                  "hls-module-name-plugin", "hls-pragmas-plugin",
                  "hls-refine-imports-plugin", "hls-retrie-plugin",
                  "hls-splice-plugin", "hls-tactics-plugin",
                  "hls-call-hierarchy-plugin"]
        ghc: ["9.0.1", "8.10.7", "8.8.4", "8.6.5"]

    steps:

      - uses: actions/checkout@v2
        with:
          submodules: true

      - uses: haskell/actions/setup@v1
        with:
          ghc-version: ${{ matrix.ghc }}
          cabal-version: '3.4'

      # Needs to be before Cache Cabal so the cache can detect changes to the modified cabal.project file
      - if: ${{ matrix.ghc == '9.0.1' }}
        name: Use modified cabal.project for ghc9
        run: cp cabal-ghc901.project cabal.project

      - name: Cache Cabal
        uses: actions/cache@v2
        env:
          cache-name: cache-cabal
        with:
          path: |
            ~/.cabal/packages
            ~/.cabal/store
          key: v2-${{ runner.os }}-${{ matrix.ghc }}-build-${{ hashFiles('cabal.project') }}
          restore-keys: |
            v2-${{ runner.os }}-${{ matrix.ghc }}-bench-${{ hashFiles('cabal.project') }}
            v2-${{ runner.os }}-${{ matrix.ghc }}-build-
            v2-${{ runner.os }}-${{ matrix.ghc }}

      - name: "Run cabal check"
        run: |
          if [[ ${{ matrix.package }} == *plugin ]]; then
            cd plugins
          fi
          cd ${{ matrix.package }}
          cabal check

      - name: "Build with hackage head"
        run: cabal build --index-state=HEAD ${{ matrix.package }}

      - name: "Generate haddock for hackage"
        run: cabal haddock --index-state=HEAD --haddock-for-hackage ${{ matrix.package }}

