#!/bin/sh

exedir="@@EXE_DIR@@"
executablename="@@EXE_NAME@@"
GHC_VERSION="@@GHC_VERSION@@"

fail_libdir() {
	echo >&2 "Could not find a GHC installation!"
	echo >&2 "Consider setting GHC_LIBDIR env variable to the top-level directory of GHC shipped libraries (version ${GHC_VERSION})."
	echo >&2 "This is needed to find dynamic libraries."
	echo >&2 "exiting..."
	exit 42
}

# try GHC_LIBDIR from the environment (e.g. user set it)
if [ -n "${GHC_LIBDIR}" ] ; then
	:
# try hls-wrapper --print-libdir
elif command -v "${exedir}"/haskell-language-server-wrapper >/dev/null ; then
	GHC_LIBDIR="$("${exedir}"/haskell-language-server-wrapper --print-libdir)" || unset GHC_LIBDIR
fi

if [ -z "${GHC_LIBDIR}" ] ; then
# try ghcup, if available
	if command -v ghcup >/dev/null ; then
		GHC_LIBDIR="$(ghcup whereis -d ghc ${GHC_VERSION})/../lib/ghc-${GHC_VERSION}/" || unset GHC_LIBDIR
	fi
fi

# if above failed, try to examine ghc in PATH
if [ -z "${GHC_LIBDIR}" ] ; then
	if [ -n "${GHC_BIN}" ] && command -v "${GHC_BIN}" >/dev/null ; then
		ghc_bin=${GHC_BIN}
	elif command -v ghc-${GHC_VERSION} >/dev/null ; then
		ghc_bin=ghc-${GHC_VERSION}
	elif command -v ghc >/dev/null ; then
		ghc_bin=ghc
	else
		fail_libdir
	fi

	GHC_LIBDIR=$(${ghc_bin} --print-libdir)
	ghc_ver="$(${ghc_bin} --numeric-version)"
	if [ "${GHC_VERSION}" != "${ghc_ver}" ] ; then
		echo >&2 "Need GHC version ${GHC_VERSION}, got ${ghc_ver}... trying anyway"
	fi
	unset ghc_ver ghc_bin
fi

if [ -z "${GHC_LIBDIR}" ] ; then
	fail_libdir
fi

if [ -n "$LD_LIBRARY_PATH" ] ; then
	LD_LIBRARY_PATH="$(for i in "${GHC_LIBDIR}"/* ; do [ -d "$i" ] && printf "%s" "$i:" ; done)$LD_LIBRARY_PATH"
	export LD_LIBRARY_PATH
else
	LD_LIBRARY_PATH="$(for i in "${GHC_LIBDIR}"/* ; do [ -d "$i" ] && printf "%s" "$i:" ; done | sed 's/:$//')"
	export LD_LIBRARY_PATH
fi

exec "${exedir}/${executablename}" ${1+"$@"}
